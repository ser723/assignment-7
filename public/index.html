<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jokebook API Client</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Use Inter font */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc;
        }
        /* Custom scrollbar for better appearance */
        #jokeListContainer::-webkit-scrollbar {
            width: 8px;
        }
        #jokeListContainer::-webkit-scrollbar-thumb {
            background-color: #a0aec0;
            border-radius: 4px;
        }
        #jokeListContainer::-webkit-scrollbar-track {
            background-color: #edf2f7;
        }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">
    <div class="max-w-4xl mx-auto">
        
        <!-- Header -->
        <header class="text-center mb-10 p-6 bg-white rounded-xl shadow-lg">
            <h1 class="text-4xl font-extrabold text-blue-600">The Jokebook API Client</h1>
            <p class="mt-2 text-gray-600">Test the endpoints: fetch categories, fetch a random joke, display joke data and joke  form submission.</p>
        </header>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- Column 1: Categories -->
            <div class="lg:col-span-1 p-6 bg-white rounded-xl shadow-lg">
                <h2 class="text-2xl font-semibold mb-4 text-gray-800 border-b pb-2">Categories</h2>
                <button id="fetchCategoriesBtn" 
                        class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300 transform hover:scale-105 mb-4">
                    Load Categories
                </button>
                <div id="categoryListContainer" class="space-y-2 max-h-64 overflow-y-auto">
                    <p class="text-gray-500">Click the button to load categories from the server.</p>
                </div>
            </div>

            <!-- Column 2: Random Joke & Submission Form -->
            <div class="lg:col-span-2 space-y-8">
                
                <!-- Random Joke Section -->
                <div class="p-6 bg-white rounded-xl shadow-lg">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-800 border-b pb-2">Random Joke</h2>
                    <div id="randomJokeDisplay" class="min-h-[100px] bg-gray-50 p-4 rounded-lg shadow-inner">
                        <p class="text-lg font-medium text-gray-700" id="jokeSetup">...</p>
                        <p class="text-xl font-bold text-blue-800 mt-2" id="jokeDelivery">Hit 'Get Random Joke'!</p>
                        <p class="text-sm text-gray-500 mt-1" id="jokeCategory"></p>
                    </div>
                    <button id="fetchRandomJokeBtn" 
                            class="w-full mt-4 bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300 transform hover:scale-105">
                        Get Random Joke
                    </button>
                </div>

                <!-- Add Joke Section -->
                <div class="p-6 bg-white rounded-xl shadow-lg">
                    <h2 class="text-2xl font-semibold mb-4 text-gray-800 border-b pb-2">Add a New Joke</h2>
                    <form id="addJokeForm" class="space-y-4">
                        <div>
                            <label for="newCategory" class="block text-sm font-medium text-gray-700">Category Name</label>
                            <input type="text" id="newCategory" required 
                                   class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="newSetup" class="block text-sm font-medium text-gray-700">Setup (Question)</label>
                            <textarea id="newSetup" required rows="2"
                                      class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-blue-500 focus:border-blue-500"></textarea>
                        </div>
                        <div>
                            <label for="newDelivery" class="block text-sm font-medium text-gray-700">Delivery (Punchline)</label>
                            <textarea id="newDelivery" required rows="2"
                                      class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border focus:ring-blue-500 focus:border-blue-500"></textarea>
                        </div>
                        <button type="submit" id="addJokeBtn"
                                class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300 transform hover:scale-105">
                            Submit Joke
                        </button>
                    </form>
                    <div id="jokeStatusMessage" class="mt-4 p-3 rounded-lg text-sm hidden"></div>
                </div>
            </div>
            
        </div>
    </div>

    <!-- JavaScript Client Logic (The equivalent of script.js) -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const BASE_URL = '/jokebook'; 
            
            // --- Helper Functions for UI ---
            
            // Function to display messages in the console and status box
            function showStatus(message, isSuccess = true) {
                const statusDiv = document.getElementById('jokeStatusMessage');
                statusDiv.textContent = message;
                statusDiv.className = 'mt-4 p-3 rounded-lg text-sm';
                statusDiv.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700');
                
                if (isSuccess) {
                    statusDiv.classList.add('bg-green-100', 'text-green-700');
                } else {
                    statusDiv.classList.add('bg-red-100', 'text-red-700');
                }
                statusDiv.scrollIntoView({ behavior: 'smooth' });
            }

            // --- 1. Fetch and Display Categories ---
            
            const fetchCategories = async () => {
                const btn = document.getElementById('fetchCategoriesBtn');
                const listContainer = document.getElementById('categoryListContainer');
                
                btn.disabled = true;
                listContainer.innerHTML = '<p class="text-center text-blue-500">Loading...</p>';

                try {
                    const response = await fetch(`${BASE_URL}/categories`);
                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.error || 'Failed to fetch categories.');
                    }

                    listContainer.innerHTML = ''; // Clear loading message
                    if (data.length === 0) {
                        listContainer.innerHTML = '<p class="text-gray-500">No categories found.</p>';
                        return;
                    }

                    data.forEach(categoryName => {
                        const div = document.createElement('div');
                        div.className = 'p-2 bg-blue-50 rounded-md text-blue-800 font-medium text-sm border border-blue-200';
                        div.textContent = categoryName.toUpperCase();
                        listContainer.appendChild(div);
                    });
                    showStatus('Categories loaded successfully.', true);

                } catch (error) {
                    console.error('Error fetching categories:', error);
                    listContainer.innerHTML = '<p class="text-red-500">Error loading categories.</p>';
                    showStatus(`Error loading categories: ${error.message}`, false);
                } finally {
                    btn.disabled = false;
                }
            };

            document.getElementById('fetchCategoriesBtn').addEventListener('click', fetchCategories);


            // --- 2. Fetch and Display Random Joke ---
            
            const fetchRandomJoke = async () => {
                const btn = document.getElementById('fetchRandomJokeBtn');
                const setupEl = document.getElementById('jokeSetup');
                const deliveryEl = document.getElementById('jokeDelivery');
                const categoryEl = document.getElementById('jokeCategory');

                btn.disabled = true;
                setupEl.textContent = '... Thinking ...';
                deliveryEl.textContent = '';
                categoryEl.textContent = '';

                try {
                    const response = await fetch(`${BASE_URL}/random`);
                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.error || 'Failed to fetch joke.');
                    }
                    
                    setupEl.textContent = data.setup || 'No setup provided.';
                    deliveryEl.textContent = data.delivery || 'No punchline provided.';
                    categoryEl.textContent = `Category: ${data.category || 'Unknown'}`;
                    
                    showStatus('Random joke fetched successfully!', true);

                } catch (error) {
                    console.error('Error fetching random joke:', error);
                    setupEl.textContent = 'Failed to load joke.';
                    deliveryEl.textContent = 'Server error or no jokes in DB.';
                    categoryEl.textContent = '';
                    showStatus(`Error fetching random joke: ${error.message}`, false);
                } finally {
                    btn.disabled = false;
                }
            };

            document.getElementById('fetchRandomJokeBtn').addEventListener('click', fetchRandomJoke);
            

            // --- 3. Add New Joke ---
            
            const addJoke = async (event) => {
                event.preventDefault();

                const form = document.getElementById('addJokeForm');
                const btn = document.getElementById('addJokeBtn');
                const categoryInput = document.getElementById('newCategory');
                const setupInput = document.getElementById('newSetup');
                const deliveryInput = document.getElementById('newDelivery');

                btn.disabled = true;
                btn.textContent = 'Submitting...';
                
                const jokeData = {
                    category: categoryInput.value.trim(),
                    setup: setupInput.value.trim(),
                    delivery: deliveryInput.value.trim(),
                };

                try {
                    const response = await fetch(`${BASE_URL}/jokes`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(jokeData),
                    });

                    const data = await response.json();

                    if (!response.ok) {
                        // Handle 400 Bad Request or other server errors
                        throw new Error(data.error || 'Submission failed.');
                    }
                    
                    showStatus(data.message || `Joke added! New ID: ${data.joke.id}`, true);
                    form.reset(); // Clear the form on success
                    fetchCategories(); // Refresh categories to show the new one if created

                } catch (error) {
                    console.error('Error adding joke:', error);
                    showStatus(`Failed to add joke: ${error.message}`, false);
                } finally {
                    btn.disabled = false;
                    btn.textContent = 'Submit Joke';
                }
            };

            document.getElementById('addJokeForm').addEventListener('submit', addJoke);
            
            // Initial load: Fetch categories immediately
            fetchCategories();
        });
    </script>
</body>
</html>